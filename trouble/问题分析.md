netstat 网络连接

xxxx 网络抓包记录流量

# 代码

打印以下日志的源代码中上下文是什么？下一秒重连是定时器触发的吗？修改系统时间会造成多大的干扰？造成定时器无法 timeout 无法执行回调？

> 8588765 May 24 15:14:57 pc30 journal: Synergy 1.14.5: [2023-05-24T15:14:57] WARNING: failed to connect to server: server is not responding

作者没有使用任何库的定时器，而是自己获取时间后计算时间差自己轮的：

```cpp
// unix 基于
double
ArchTimeUnix::time()
{
    struct timeval t;
    // 修改系统时间会干扰此函数
    gettimeofday(&t, NULL);
    return (double)t.tv_sec + 1.0e-6 * (double)t.tv_usec;
}

// windows 实现。修改系统时间不会造成影响
double
ArchTimeWindows::time()
{
    // get time.  we try three ways, in order of descending precision
    if (s_freq != 0.0) {
        LARGE_INTEGER c;
        QueryPerformanceCounter(&c);
        return s_freq * static_cast<double>(c.QuadPart);
    }
    else if (s_tgt != NULL) {
        // timeGetTime()
        return 0.001 * static_cast<double>(s_tgt());
    }
    else {
        return 0.001 * static_cast<double>(GetTickCount());
    }
}
```

在 linux 平台，上述实现造成 [隐患](https://github.com/symless/synergy-core/issues/7258) 

# 复现

```bash
# 第一次改时间 t1 使 synergy 连接中断；第二次修改将时间回退 t2
# 如果重连安排在 t1+1 秒，那么要等 t1+1-t2 秒之后才会触发重连
date -s "+3 sec" && date -s "-1 year"
```

有没有配置入口，能够修改重连的间隔时长？

> 没有入口哟，代码是宏定义的常量

# 方案

目前的校时特征：古往今来，大跨度地调整系统时间。

降低在(startTimer, timeout) 之间修改系统时间的概率  ：校时可能会修改系统时间，也可能不会修改

- 降低校时的频率（或增大修改系统时间的最小间隔）；目前的策略是“来者不拒”
- 减少断网（修改系统时间可能会造成中断；网络问题会造成中断）；
- 或调小重连的间隔时长；目前是一秒。

鉴于更频繁的重试（重新连接）会占用更多的系统资源，而且降低校时的频率也会减少网络中断，建议采用：增大修改系统时间的最小间隔。

根本问题：为什么时间不准，未来的、过去的都有。

- 发送了错误报文？能不能不发？
- 能不能判断出错误报文，错误的时间？过滤掉
- 过滤不掉？能不能每小时修改一次系统时间？每几分钟呢？

理论上来将，只要修改系统时间，结合网络的不稳定天性，就无法完全避免上述问题的发生。但是：

- 局域网我们趋向于认为是稳定的；
- 如果修改系统时间的跨度较小，比如前后相差 N 秒，那么最多等待 N 秒重连就会触发，键鼠就会恢复正常。

## 应急手段 workaround

见 shortcut 目录，提供组合键一键恢复（一键重启）